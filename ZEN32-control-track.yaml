blueprint:
  name: ZEN32 Scene and State (Z-Wave JS)
  description: >
    Trigger on button press with LED state tracking for Zooz ZEN32.

    **Version**: 2024.5.1-71

    **Recommended** to disable parameter 23 on your Zen32 - this stops the green flashing.  If you disable the relay, enable parameter 20.
  domain: automation
  source_url: https://github.com/rwalker777/Zen32-HA-Blueprint/blob/main/ZEN32-control-track.yaml
  homeassistant:
    min_version: 2024.4.0

  input:
    zooz_switch:
      name: Zooz Switch
      description: List of available Zooz ZEN32 switches.
      selector:
        device:
          filter:
            - integration: zwave_js
              manufacturer: Zooz
              model: ZEN32
            - integration: zwave_js
              manufacturer: Zooz
              model: ZEN32 800LR
          multiple: false
#############
    schedule_start:
      name: Night time LEDs start time
      description: "LEDs are dimmed or turned off at this time.  Scenes will still run.  To disable leave at 00:00:00 default."
      default: '00:00:00'
      selector:
        time:
    night_led_brightness:
      name: Night time LED setting.
      description: Disable or override brightness of LEDs between schedule times.
      default: '99'
      selector: &led_set_selector
        select:
          mode: dropdown
          options:
            - label: Led off
              value: '99'
            - label: Low
              value: '2'
            - label: Medium
              value: '1'
            - label: Bright
              value: '0'
    schedule_stop:
      name: Night time LEDs stop time
      description: "LED tracking is restored.  To disable leave at 00:00:00 default."
      default: '00:00:00'
      selector:
        time:
############
    scene_5:
      name: Big button - Pressed Once
      description: Action to run when button is pressed once.
      default: []
      selector:
        action:
    input_entity0:
      name: Entity for button 1 (Big button)
      description: >
        (Optional) Override the entity to track

        Track different entity or set if LED track is not as expected
      default: []
      selector: &entity_selector
        entity:
          multiple: false
          domain:
            - alarm_control_panel
            - binary_sensor
            - climate
            - cover
            - fan
            - input_boolean
            - light
            - lock
            - media_player
            - sensor
            - switch
    off_state0:
      name: Off behavior for button 1
      description: Led state when target is off, closed, disarmed or locked
      default: '1'
      selector: *led_set_selector
    off_color0:
      name: Off color for button 1
      description: Color for led when target is off (default white)
      default: '0'
      selector: &led_color_selector
        select:
          mode: dropdown
          options:
            - label: White
              value: '0'
            - label: Blue
              value: '1'
            - label: Green
              value: '2'
            - label: Red
              value: '3'
            - label: Magenta
              value: '4'
            - label: Yellow
              value: '5'
            - label: Cyan
              value: '6'
    on_state0:
      name: On behavior for button 1
      description: Led state when target is on, opened, armed or unlocked
      default: '1'
      selector: *led_set_selector
    on_color0:
      name: On color for button 1
      description: Color for led when target is on (default white)
      default: '1'
      selector: *led_color_selector
    unavail_state0:
      name: Unavailable State for button 1
      description: Led state when target is unavailable
      default: '1'
      selector: *led_set_selector
    unavail_color0:
      name: Unavailable Color for button 1
      description: Color for led when target is unavailable (default red)
      default: '3'
      selector: *led_color_selector
#############
    scene_1:
      name: Top left button - Pressed Once
      description: Action to run when button is pressed once.
      default: []
      selector:
        action:
    input_entity1:
      name: Entity for button 2 (Top left button)
      description: >
        (Optional) Override the entity to track

        Track different entity or set if LED track is not as expected
      default: []
      selector: *entity_selector
    off_state1:
      name: Off behavior for button 2
      description: Led state when target is off, closed, disarmed or locked
      default: '1'
      selector: *led_set_selector
    off_color1:
      name: Off color for button 2
      description: Color for led when target is off (default white)
      default: '0'
      selector: *led_color_selector
    on_state1:
      name: On behavior for button 2
      description: Led state when target is on, opened, armed or unlocked
      default: '1'
      selector: *led_set_selector
    on_color1:
      name: On color for button 2
      description: Color for led when target is on (default white)
      default: '2'
      selector: *led_color_selector
    unavail_state1:
      name: Unavailable State for button 2
      description: Led state when target is unavailable
      default: '1'
      selector: *led_set_selector
    unavail_color1:
      name: Unavailable Color for button 2
      description: Color for led when target is unavailable (default red)
      default: '3'
      selector: *led_color_selector
#############
    scene_2:
      name: Top right button - Pressed Once
      description: Action to run when button is pressed once.
      default: []
      selector:
        action:
    input_entity2:
      name: Entity for button 3 (Top right button)
      description: >
        (Optional) Override the entity to track

        Track different entity or set if LED track is not as expected
      default: []
      selector: *entity_selector
    off_state2:
      name: Off behavior for button 3
      description: Led state when target is off, closed, disarmed or locked
      default: '1'
      selector: *led_set_selector
    off_color2:
      name: Off color for button 3
      description: Color for led when target is off (default white)
      default: '0'
      selector: *led_color_selector
    on_state2:
      name: On behavior for button 3
      description: Led state when target is on, opened, armed or unlocked
      default: '1'
      selector: *led_set_selector
    on_color2:
      name: On color for button 3
      description: Color for led when target is on (default white)
      default: '2'
      selector: *led_color_selector
    unavail_state2:
      name: Unavailable State for button 3
      description: Led state when target is unavailable
      default: '1'
      selector: *led_set_selector
    unavail_color2:
      name: Unavailable Color for button 3
      description: Color for led when target is unavailable (default red)
      default: '3'
      selector: *led_color_selector
#############
    scene_3:
      name: Bottom left button - Pressed Once
      description: Action to run when button is pressed once.
      default: []
      selector:
        action:
    input_entity3:
      name: Entity for button 4 (Bottom left button)
      description: >
        (Optional) Override the entity to track

        Track different entity or set if LED track is not as expected
      default: []
      selector: *entity_selector
    off_state3:
      name: Off behavior for button 4
      description: Led state when target is off, closed, disarmed or locked
      default: '1'
      selector: *led_set_selector
    off_color3:
      name: Off color for button 4
      description: Color for led when target is off (default white)
      default: '0'
      selector: *led_color_selector
    on_state3:
      name: On behavior for button 4
      description: Led state when target is on, opened, armed or unlocked
      default: '1'
      selector: *led_set_selector
    on_color3:
      name: On color for button 4
      description: Color for led when target is on (default white)
      default: '2'
      selector: *led_color_selector
    unavail_state3:
      name: Unavailable State for button 4
      description: Led state when target is unavailable
      default: '1'
      selector: *led_set_selector
    unavail_color3:
      name: Unavailable Color for button 4
      description: Color for led when target is unavailable (default red)
      default: '3'
      selector: *led_color_selector
#############
    scene_4:
      name: Bottom right button - Pressed Once
      description: Action to run when button is pressed once.
      default: []
      selector:
        action:
    input_entity4:
      name: Entity for button 5 (Bottom right button)
      description: >
        (Optional) Override the entity to track

        Track different entity or set if LED track is not as expected
      default: []
      selector: *entity_selector
    off_state4:
      name: Off behavior for button 5
      description: Led state when target is off, closed, disarmed or locked
      default: '1'
      selector: *led_set_selector
    off_color4:
      name: Off color for button 5
      description: Color for led when target is off (default white)
      default: '0'
      selector: *led_color_selector
    on_state4:
      name: On behavior for button 5
      description: Led state when target is on, opened, armed or unlocked
      default: '1'
      selector: *led_set_selector
    on_color4:
      name: On color for button 5
      description: Color for led when target is on (default white)
      default: '2'
      selector: *led_color_selector
    unavail_state4:
      name: Unavailable State for button 5
      description: Led state when target is unavailable
      default: '1'
      selector: *led_set_selector
    unavail_color4:
      name: Unavailable Color for button 5
      description: Color for led when target is unavailable (default red)
      default: '3'
      selector: *led_color_selector
#############
    scene_5h:
      name: Scene 5 - Held
      description: Action to run when button is held.
      default: []
      selector:
        action:
    scene_1h:
      name: Scene 1 - Held
      description: Action to run when button is held.
      default: []
      selector:
        action:
    scene_2h:
      name: Scene 2 - Held
      description: Action to run when button is held.
      default: []
      selector:
        action:
    scene_3h:
      name: Scene 3 - Held
      description: Action to run when button is held.
      default: []
      selector:
        action:
    scene_4h:
      name: Scene 4 - Held
      description: Action to run when button is held.
      default: []
      selector:
        action:
    scene_5r:
      name: Scene 5 - Released
      description: Action to run when button is released.
      default: []
      selector:
        action:
    scene_1r:
      name: Scene 1 - Released
      description: Action to run when button is released.
      default: []
      selector:
        action:
    scene_2r:
      name: Scene 2 - Released
      description: Action to run when button is released.
      default: []
      selector:
        action:
    scene_3r:
      name: Scene 3 - Released
      description: Action to run when button is released.
      default: []
      selector:
        action:
    scene_4r:
      name: Scene 4 - Released
      description: Action to run when button is released.
      default: []
      selector:
        action:
    scene_52:
      name: Scene 5 - Pressed 2x
      description: Action to run when button is pressed twice.
      default: []
      selector:
        action:
    scene_12:
      name: Scene 1 - Pressed 2x
      description: Action to run when button is pressed twice.
      default: []
      selector:
        action:
    scene_22:
      name: Scene 2 - Pressed 2x
      description: Action to run when button is pressed twice.
      default: []
      selector:
        action:
    scene_32:
      name: Scene 3 - Pressed 2x
      description: Action to run when button is pressed twice.
      default: []
      selector:
        action:
    scene_42:
      name: Scene 4 - Pressed 2x
      description: Action to run when button is pressed twice.
      default: []
      selector:
        action:
    scene_53:
      name: Scene 5 - Pressed 3x
      description: Action to run when button is pressed three times.
      default: []
      selector:
        action:
    scene_13:
      name: Scene 1 - Pressed 3x
      description: Action to run when button is pressed three times.
      default: []
      selector:
        action:
    scene_23:
      name: Scene 2 - Pressed 3x
      description: Action to run when button is pressed three times.
      default: []
      selector:
        action:
    scene_33:
      name: Scene 3 - Pressed 3x
      description: Action to run when button is pressed three times.
      default: []
      selector:
        action:
    scene_43:
      name: Scene 4 - Pressed 3x
      description: Action to run when button is pressed three times.
      default: []
      selector:
        action:
    scene_54:
      name: Scene 5 - Pressed 4x
      description: Action to run when button is pressed four times.
      default: []
      selector:
        action:
    scene_14:
      name: Scene 1 - Pressed 4x
      description: Action to run when button is pressed four times.
      default: []
      selector:
        action:
    scene_24:
      name: Scene 2 - Pressed 4x
      description: Action to run when button is pressed four times.
      default: []
      selector:
        action:
    scene_34:
      name: Scene 3 - Pressed 4x
      description: Action to run when button is pressed four times.
      default: []
      selector:
        action:
    scene_44:
      name: Scene 4 - Pressed 4x
      description: Action to run when button is pressed four times.
      default: []
      selector:
        action:
    scene_55:
      name: Scene 5 - Pressed 5x
      description: Action to run when button is pressed five times.
      default: []
      selector:
        action:
    scene_15:
      name: Scene 1 - Pressed 5x
      description: Action to run when button is pressed five times.
      default: []
      selector:
        action:
    scene_25:
      name: Scene 2 - Pressed 5x
      description: Action to run when button is pressed five times.
      default: []
      selector:
        action:
    scene_35:
      name: Scene 3 - Pressed 5x
      description: Action to run when button is pressed five times.
      default: []
      selector:
        action:
    scene_45:
      name: Scene 4 - Pressed 5x
      description: Action to run when button is pressed five times.
      default: []
      selector:
        action:
#############
mode: parallel
max: 10
variables:
  controller_id: !input 'zooz_switch'
  toggle_offset: 1
  color_offset: 6
  brightness_offset: 11
  night_led_brightness: !input 'night_led_brightness'
  schedule_start: !input 'schedule_start'
  schedule_stop: !input 'schedule_stop'
  schedule_set: '{{ schedule_start != schedule_stop }}'
  in_nighttime: '{{ today_at(schedule_start) <= now() or now() <= today_at(schedule_stop) }}'

# Track override entry if set, else get first entity in scene, if neither set to empty
trigger_variables:
  input_scene5: !input 'scene_5'
  input_entity0: !input 'input_entity0'
  input_scene1: !input 'scene_1'
  input_entity1: !input 'input_entity1'
  input_scene2: !input 'scene_2'
  input_entity2: !input 'input_entity2'
  input_scene3: !input 'scene_3'
  input_entity3: !input 'input_entity3'
  input_scene4: !input 'scene_4'
  input_entity4: !input 'input_entity4'
  inputs:
  - button_id: 0
    off_state: !input 'off_state0'
    off_color: !input 'off_color0'
    on_state: !input 'on_state0'
    on_color: !input 'on_color0'
    unavail_state: !input 'unavail_state0'
    unavail_color: !input 'unavail_color0'
    trigger_entity: '{{ input_entity0 if input_entity0 else input_scene5[0].target.entity_id if input_scene5 | count > 0 else input_entity0 }}'
  - button_id: 1
    off_state: !input 'off_state1'
    off_color: !input 'off_color1'
    on_state: !input 'on_state1'
    on_color: !input 'on_color1'
    unavail_state: !input 'unavail_state1'
    unavail_color: !input 'unavail_color1'
    trigger_entity: '{{ input_entity1 if input_entity1 else input_scene1[0].target.entity_id if input_scene1 | count > 0 else input_entity1 }}'
  - button_id: 2
    off_state: !input 'off_state2'
    off_color: !input 'off_color2'
    on_state: !input 'on_state2'
    on_color: !input 'on_color2'
    unavail_state: !input 'unavail_state2'
    unavail_color: !input 'unavail_color2'
    trigger_entity: '{{ input_entity2 if input_entity2 else input_scene2[0].target.entity_id if input_scene2 | count > 0 else input_entity2 }}'
  - button_id: 3
    off_state: !input 'off_state3'
    off_color: !input 'off_color3'
    on_state: !input 'on_state3'
    on_color: !input 'on_color3'
    unavail_state: !input 'unavail_state3'
    unavail_color: !input 'unavail_color3'
    trigger_entity: '{{ input_entity3 if input_entity3 else input_scene3[0].target.entity_id if input_scene3 | count > 0 else input_entity3 }}'
  - button_id: 4
    off_state: !input 'off_state4'
    off_color: !input 'off_color4'
    on_state: !input 'on_state4'
    on_color: !input 'on_color4'
    unavail_state: !input 'unavail_state4'
    unavail_color: !input 'unavail_color4'
    trigger_entity: '{{ input_entity4 if input_entity4 else input_scene4[0].target.entity_id if input_scene4 | count > 0 else input_entity4 }}'

##### Triggers #####
trigger:
  - alias: 'ButtonPress'
    id: 'ButtonPress'
    platform: event
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input 'zooz_switch'
      command_class_name: 'Central Scene'
  - alias: 'NightTime'
    id: 'NightTime'
    platform: time
    at: !input 'schedule_start'
  - alias: 'DayTime'
    id: 'DayTime'
    platform: time
    at: !input 'schedule_stop'
  - alias: 'HassStart'
    id: 'HassStart'
    platform: homeassistant
    event: start
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: '{{ inputs[0].trigger_entity }}'
    id: 'StateTrigger'
    alias: '0'
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: '{{ inputs[1].trigger_entity }}'
    id: 'StateTrigger'
    alias: '1'
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: '{{ inputs[2].trigger_entity }}'
    id: 'StateTrigger'
    alias: '2'
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: '{{ inputs[3].trigger_entity }}'
    id: 'StateTrigger'
    alias: '3'
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: '{{ inputs[4].trigger_entity }}'
    id: 'StateTrigger'
    alias: '4'

##### Actions ######
action:
  choose:
    # If button was pressed run scene
    - conditions: '{{ trigger.alias == ''ButtonPress'' }}'
      alias: 'ButtonPressAction'
      sequence:
        - variables:
            property_key_name: '{{ trigger.event.data.property_key_name }}'
            label: '{{ trigger.event.data.label }}'
            command_class_name: '{{ trigger.event.data.command_class_name }}'
            value: '{{ trigger.event.data.value }}'
        - service: logbook.log
          data:
            name: 'Z-Wave JS'
            message: 'received event: {{ command_class_name }} - {{ value }} - {{ label }}'
        - choose:
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyPressed'' }}'
            sequence: !input 'scene_1'
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyHeldDown'' }}'
            sequence: !input 'scene_1h'
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyReleased'' }}'
            sequence: !input 'scene_1r'
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyPressed2x'' }}'
            sequence: !input 'scene_12'
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyPressed3x'' }}'
            sequence: !input 'scene_13'
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyPressed4x'' }}'
            sequence: !input 'scene_14'
          - conditions: '{{ property_key_name == ''001'' and value == ''KeyPressed5x'' }}'
            sequence: !input 'scene_15'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyPressed'' }}'
            sequence: !input 'scene_2'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyHeldDown'' }}'
            sequence: !input 'scene_2h'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyReleased'' }}'
            sequence: !input 'scene_2r'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyPressed2x'' }}'
            sequence: !input 'scene_22'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyPressed3x'' }}'
            sequence: !input 'scene_23'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyPressed4x'' }}'
            sequence: !input 'scene_24'
          - conditions: '{{ property_key_name == ''002'' and value == ''KeyPressed5x'' }}'
            sequence: !input 'scene_25'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyPressed'' }}'
            sequence: !input 'scene_3'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyHeldDown'' }}'
            sequence: !input 'scene_3h'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyReleased'' }}'
            sequence: !input 'scene_3r'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyPressed2x'' }}'
            sequence: !input 'scene_32'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyPressed3x'' }}'
            sequence: !input 'scene_33'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyPressed4x'' }}'
            sequence: !input 'scene_34'
          - conditions: '{{ property_key_name == ''003'' and value == ''KeyPressed5x'' }}'
            sequence: !input 'scene_35'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyPressed'' }}'
            sequence: !input 'scene_4'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyHeldDown'' }}'
            sequence: !input 'scene_4h'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyReleased'' }}'
            sequence: !input 'scene_4r'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyPressed2x'' }}'
            sequence: !input 'scene_42'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyPressed3x'' }}'
            sequence: !input 'scene_43'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyPressed4x'' }}'
            sequence: !input 'scene_44'
          - conditions: '{{ property_key_name == ''004'' and value == ''KeyPressed5x'' }}'
            sequence: !input 'scene_45'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyPressed'' }}'
            sequence: !input 'scene_5'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyHeldDown'' }}'
            sequence: !input 'scene_5h'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyReleased'' }}'
            sequence: !input 'scene_5r'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyPressed2x'' }}'
            sequence: !input 'scene_52'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyPressed3x'' }}'
            sequence: !input 'scene_53'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyPressed4x'' }}'
            sequence: !input 'scene_54'
          - conditions: '{{ property_key_name == ''005'' and value == ''KeyPressed5x'' }}'
            sequence: !input 'scene_55'
    # If track entity state changes update LEDs if state changed (not just an attribute, like cover position) and NOT -Nighttime AND LEDs set to off-
    # If Nightime with LED brightness set we still update but ignore brightness setting
    - conditions: '{{ trigger.id == ''StateTrigger'' and ( trigger.event.data.new_state.state != trigger.event.data.old_state.state ) and not ( schedule_set and in_nighttime and night_led_brightness == ''99'') }}'
      alias: 'StateAction'
      sequence: 
      - variables:
          current: >
            {{ inputs[trigger.alias | int] }}
          condition: >
            {% if trigger.event.data.new_state.state in ["off", "closed", "closing", "false", "False", false, False, "standby", "paused", "idle", "disarmed", "disarming", "locked"] %}
              {{ dict(state=current.off_state, color=current.off_color) }}
            {% elif trigger.event.data.new_state.state in ["on", "open", "opening", "true", "True", true, True, "playing", "heat", "cold", "dry", "armed_home", "armed_away", "armed_vacation", "armed_custom_bypass", "triggered", "pending", "arming", "unlocked", 1] %}
              {{ dict(state=current.on_state, color=current.on_color) }}
            {% elif trigger.event.data.new_state.state == "unavailable" %}
              {{ dict(state=current.unavail_state, color=current.unavail_color) }}
            {% else %}
              {{ dict(state=None, color=None) }}
            {% endif %}
          parameter:
            toggle: "{{ current.button_id | int + toggle_offset | int }}"
            color: "{{ current.button_id | int + color_offset | int }}"
            brightness: "{{ current.button_id | int + brightness_offset | int }}"
      - choose:
        # If 99 turn off LEDs
        - conditions: '{{ condition.state == ''99'' }}'
          sequence:
            - service: zwave_js.set_config_parameter
              data:
                parameter: '{{ parameter.toggle }}'
                value: '2'
              target:
                device_id: '{{ controller_id }}'
        # Else turn on, set brightness and color
        - conditions: '{{ condition.state != ''99'' }}'
          sequence:
          - parallel:
            # turn indicator on
            - service: zwave_js.set_config_parameter
              data:
                parameter: '{{ parameter.toggle }}'
                value: '3'
              target:
                device_id: '{{ controller_id }}'
            # set indicator color
            - service: zwave_js.set_config_parameter
              data:
                parameter: '{{ parameter.color }}'
                value: '{{ condition.color }}'
              target:
                device_id: '{{ controller_id }}'
            # Make sure we are not in night time with schedule set
            - choose:
              - conditions: '{{ not (in_nighttime and schedule_set) }}'
                sequence:
                # set brightness
                - service: zwave_js.set_config_parameter
                  data:
                    parameter: '{{ parameter.brightness }}'
                    value: '{{ condition.state }}'
                  target:
                    device_id: '{{ controller_id }}'
    # At night time turn off LEDs or change brightness if time set
    - conditions: '{{ trigger.id == ''NightTime'' and schedule_set }}'
      alias: 'NightTimeAction'
      sequence:
        choose:
        # If 99 turn off LEDs
        - conditions: '{{ night_led_brightness == ''99'' }}'
          sequence:
            - parallel:
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '1'
                  value: '2'
                target:
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '2'
                  value: '2'
                target:
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '3'
                  value: '2'
                target:
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '4'
                  value: '2'
                target:
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '5'
                  value: '2'
                target:
                  device_id: '{{ controller_id }}'
        # Else set brightness
        - conditions: '{{ night_led_brightness != ''99'' }}'
          sequence:
            - parallel:
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '11'
                  value: '{{ night_led_brightness }}'
                target: 
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '12'
                  value: '{{ night_led_brightness }}'
                target: 
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '13'
                  value: '{{ night_led_brightness }}'
                target: 
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '14'
                  value: '{{ night_led_brightness }}'
                target: 
                  device_id: '{{ controller_id }}'
              - service: zwave_js.set_config_parameter
                data:
                  parameter: '15'
                  value: '{{ night_led_brightness }}'
                target: 
                  device_id: '{{ controller_id }}'
    # At day time if schedule set or Home Assistant startup and not nighttime update LEDs for all buttons
    - conditions: '{{ (trigger.id == ''DayTime'' and schedule_set) or (trigger.id == ''HassStart'' and not ( schedule_set and in_nighttime and night_led_brightness == ''99'')) }}'
      alias: 'RefreshLEDAction'
      sequence:
        repeat:
          for_each: >
            {{ inputs | rejectattr('trigger_entity', 'eq', []) | list }}
          sequence:
          - variables:
              current: >
                {{ repeat.item }}
              condition: >
                {% if is_state(repeat.item.trigger_entity, ["off", "closed", "closing", "false", "False", false, False, "standby", "paused", "idle", "disarmed", "disarming", "locked"]) %}
                  {{ dict(state=current.off_state, color=current.off_color) }}
                {% elif is_state(repeat.item.trigger_entity, ["on", "open", "opening", "true", "True", true, True, "playing", "heat", "cold", "dry", "armed_home", "armed_away", "armed_vacation", "armed_custom_bypass", "triggered", "pending", "arming", "unlocked", 1]) %}
                  {{ dict(state=current.on_state, color=current.on_color) }}
                {% elif is_state(repeat.item.trigger_entity, "unavailable") %}
                  {{ dict(state=current.unavail_state, color=current.unavail_color) }}
                {% else %}
                  {{ dict(state=None, color=None) }}
                {% endif %}
              parameter:
                toggle: "{{ current.button_id | int + toggle_offset | int }}"
                color: "{{ current.button_id | int + color_offset | int }}"
                brightness: "{{ current.button_id | int + brightness_offset | int }}"
          - choose:
            # If 99 turn off LEDs
            - conditions: '{{ condition.state == ''99'' }}'
              sequence:
                - service: zwave_js.set_config_parameter
                  data:
                    parameter: '{{ parameter.toggle }}'
                    value: '2'
                  target:
                    device_id: '{{ controller_id }}'
            # Else turn on, set brightness and color
            - conditions: '{{ condition.state != ''99'' }}'
              sequence:
              - parallel:
                # turn indicator on
                - service: zwave_js.set_config_parameter
                  data:
                    parameter: '{{ parameter.toggle }}'
                    value: '3'
                  target:
                    device_id: '{{ controller_id }}'
                # set indicator color
                - service: zwave_js.set_config_parameter
                  data:
                    parameter: '{{ parameter.color }}'
                    value: '{{ condition.color }}'
                  target:
                    device_id: '{{ controller_id }}'
                # Make sure we are not in night time with schedule set
                - choose:
                  - conditions: '{{ not (in_nighttime and schedule_set) }}'
                    sequence:
                    # set brightness
                    - service: zwave_js.set_config_parameter
                      data:
                        parameter: '{{ parameter.brightness }}'
                        value: '{{ condition.state }}'
                      target:
                        device_id: '{{ controller_id }}'